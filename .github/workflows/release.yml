name: Release & Publish

on:
  push:
    branches: ["dev", "prod"]
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode"
        required: true
        default: "publish"
        type: choice
        options:
          - publish
          - release
      package:
        description: "Package to publish"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - config
          - modes
          - handoff
          - subagents
          - session-search
          - painter
          - pi-ohm
      channel:
        description: "npm dist-tag channel"
        required: true
        default: "latest"
        type: choice
        options:
          - latest
          - dev

jobs:
  publish-dev:
    if: ${{ github.event_name == 'push' && github.ref_name == 'dev' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - name: Setup Yarn
        run: |
          corepack enable
          corepack prepare yarn@4.12.0 --activate
          yarn --version

      - name: Publish all packages to npm @dev
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_ACCESS: public
          NPM_CONFIG_PROVENANCE: "false"
        run: |
          if [[ -z "${NODE_AUTH_TOKEN:-}" ]]; then
            echo "NPM_TOKEN secret is required for dev-channel publishing."
            exit 1
          fi

          node --experimental-strip-types ./scripts/publish-packages.ts --channel dev --provenance=false

  release-dev:
    if: ${{ github.ref_name == 'dev' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.mode == 'release')) }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run release-please against dev
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.RELEASE_PLEASE_TOKEN || secrets.GITHUB_TOKEN }}
          target-branch: dev
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json

  publish-prod-latest:
    if: ${{ github.event_name == 'push' && github.ref_name == 'prod' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - name: Setup Yarn
        run: |
          corepack enable
          corepack prepare yarn@4.12.0 --activate
          yarn --version

      - name: Publish released package versions to npm @latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_ACCESS: public
          NPM_CONFIG_PROVENANCE: "true"
        run: |
          if [[ -z "${NODE_AUTH_TOKEN:-}" ]]; then
            echo "NPM_TOKEN secret is required for stable publishing."
            exit 1
          fi

          node --experimental-strip-types ./scripts/publish-packages.ts --channel latest

      - name: Resolve release version
        id: release_meta
        shell: bash
        run: |
          set -euo pipefail
          version=$(node -e "const fs=require('node:fs'); const pkg=JSON.parse(fs.readFileSync('packages/extension/package.json','utf8')); process.stdout.write(pkg.version)")
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=pi-ohm-v$version" >> "$GITHUB_OUTPUT"
          echo "name=pi-ohm: v$version" >> "$GITHUB_OUTPUT"

      - name: Generate aggregated GitHub release notes
        run: |
          node --experimental-strip-types ./scripts/generate-release-notes.ts \
            --version "${{ steps.release_meta.outputs.version }}" \
            --output /tmp/pi-ohm-release-notes.md

      - name: Upsert GitHub release
        uses: actions/github-script@v7
        env:
          RELEASE_TAG: ${{ steps.release_meta.outputs.tag }}
          RELEASE_NAME: ${{ steps.release_meta.outputs.name }}
        with:
          github-token: ${{ secrets.RELEASE_PLEASE_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('node:fs');

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = process.env.RELEASE_TAG;
            const name = process.env.RELEASE_NAME;
            const body = fs.readFileSync('/tmp/pi-ohm-release-notes.md', 'utf8');

            try {
              const existing = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              await github.rest.repos.updateRelease({
                owner,
                repo,
                release_id: existing.data.id,
                tag_name: tag,
                name,
                body,
                draft: false,
                prerelease: false,
              });
              core.info(`Updated release ${tag}`);
            } catch (error) {
              if (error.status !== 404) throw error;

              await github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: tag,
                target_commitish: context.sha,
                name,
                body,
                draft: false,
                prerelease: false,
              });
              core.info(`Created release ${tag}`);
            }

  publish-manual:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.mode == 'publish' && (github.ref_name == 'dev' || github.ref_name == 'prod') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - name: Setup Yarn
        run: |
          corepack enable
          corepack prepare yarn@4.12.0 --activate
          yarn --version

      - name: Publish selected package(s)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_CONFIG_ACCESS: public
          NPM_CONFIG_PROVENANCE: ${{ inputs.channel == 'dev' && 'false' || 'true' }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${NODE_AUTH_TOKEN:-}" ]]; then
            echo "NPM_TOKEN secret is required for manual publishing."
            exit 1
          fi

          case "${{ inputs.package }}" in
            config)
              only="@pi-ohm/config"
              ;;
            modes)
              only="@pi-ohm/modes"
              ;;
            handoff)
              only="@pi-ohm/handoff"
              ;;
            subagents)
              only="@pi-ohm/subagents"
              ;;
            session-search)
              only="@pi-ohm/session-search"
              ;;
            painter)
              only="@pi-ohm/painter"
              ;;
            pi-ohm)
              only="pi-ohm"
              ;;
            all)
              only=""
              ;;
            *)
              echo "Unknown package input: ${{ inputs.package }}"
              exit 1
              ;;
          esac

          cmd=(node --experimental-strip-types ./scripts/publish-packages.ts --channel "${{ inputs.channel }}")
          if [[ "${{ inputs.channel }}" == "dev" ]]; then
            cmd+=(--provenance=false)
          fi
          if [[ -n "${only}" ]]; then
            cmd+=(--only "${only}")
          fi

          echo "Running: ${cmd[*]}"
          "${cmd[@]}"
